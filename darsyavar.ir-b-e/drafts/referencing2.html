<!DOCTYPE html>
<html lang="fa">
  <head>
    <meta charset="UTF-8" />
    <title>Ø§Ø±Ø¬Ø§Ø¹ Ø¨Ø§ Ø§Ø³Ú©Ø±ÙˆÙ„ Ùˆ Ù‡Ø§ÛŒÙ„Ø§ÛŒØª</title>
    <style>
      body {
        font-family: sans-serif;
        direction: rtl;
        padding: 20px;
      }
      .container {
        display: flex;
        gap: 20px;
      }
      .text-box {
        border: 1px solid #999;
        padding: 10px;
        width: 45%;
        height: 300px;
        overflow-y: auto;
        background: #fefefe;
        line-height: 2;
      }
      .label {
        font-weight: bold;
        margin-top: 20px;
      }
      .highlight {
        background-color: yellow;
        transition: background-color 0.5s;
      }
      .ref-link {
        color: blue;
        cursor: pointer;
        font-size: 0.8em;
        margin-right: 4px;
      }
      .debug-info {
        background: #f0f0f0;
        padding: 10px;
        margin: 10px 0;
        border-radius: 5px;
        font-size: 12px;
        color: #666;
      }
    </style>
  </head>
  <body>
    <div class="label">ğŸŸ¨ Ù…ØªÙ† Ù…Ø±Ø¬Ø¹ (Ù…Ù†Ø¨Ø¹ Ø§Ø±Ø¬Ø§Ø¹):</div>
    <div id="sourceText" class="text-box">
      <p>
        Ø§ÛŒÙ† Ù…ØªÙ† Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ Ù…Ù†Ø¨Ø¹ Ø§Ø±Ø¬Ø§Ø¹ Ø§Ø³Øª. Ù…ÛŒâ€ŒØªÙˆØ§Ù† Ø¨Ø®Ø´â€ŒÙ‡Ø§ÛŒÛŒ Ø§Ø² Ø§ÛŒÙ† Ù…ØªÙ† Ø±Ø§ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù†
        Ù…Ø±Ø¬Ø¹ Ø¨Ø±Ø§ÛŒ Ø¨Ø®Ø´â€ŒÙ‡Ø§ÛŒ Ø¯ÛŒÚ¯Ø± Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ø±Ø¯. Ù‡Ø± Ø¬Ù…Ù„Ù‡ Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø¨Ù‡ ÛŒÚ© Ø¹Ø¨Ø§Ø±Øª Ø®Ø§Øµ
        Ø§Ø±Ø¬Ø§Ø¹ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯.
      </p>
      <p>
        Ø§ÛŒÙ† Ù…ØªÙ† Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ Ù…Ù†Ø¨Ø¹ Ø§Ø±Ø¬Ø§Ø¹ Ø§Ø³Øª. Ù…ÛŒâ€ŒØªÙˆØ§Ù† Ø¨Ø®Ø´â€ŒÙ‡Ø§ÛŒÛŒ Ø§Ø² Ø§ÛŒÙ† Ù…ØªÙ† Ø±Ø§ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù†
        Ù…Ø±Ø¬Ø¹ Ø¨Ø±Ø§ÛŒ Ø¨Ø®Ø´â€ŒÙ‡Ø§ÛŒ Ø¯ÛŒÚ¯Ø± Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ø±Ø¯. Ù‡Ø± Ø¬Ù…Ù„Ù‡ Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø¨Ù‡ ÛŒÚ© Ø¹Ø¨Ø§Ø±Øª Ø®Ø§Øµ
        Ø§Ø±Ø¬Ø§Ø¹ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯.
      </p>
      <p>
        Ø§ÛŒÙ† Ù…ØªÙ† Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ Ù…Ù†Ø¨Ø¹ Ø§Ø±Ø¬Ø§Ø¹ Ø§Ø³Øª. Ù…ÛŒâ€ŒØªÙˆØ§Ù† Ø¨Ø®Ø´â€ŒÙ‡Ø§ÛŒÛŒ Ø§Ø² Ø§ÛŒÙ† Ù…ØªÙ† Ø±Ø§ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù†
        Ù…Ø±Ø¬Ø¹ Ø¨Ø±Ø§ÛŒ Ø¨Ø®Ø´â€ŒÙ‡Ø§ÛŒ Ø¯ÛŒÚ¯Ø± Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ø±Ø¯. Ù‡Ø± Ø¬Ù…Ù„Ù‡ Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø¨Ù‡ ÛŒÚ© Ø¹Ø¨Ø§Ø±Øª Ø®Ø§Øµ
        Ø§Ø±Ø¬Ø§Ø¹ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯.
      </p>
    </div>

    <div class="label">ğŸŸ¦ Ù…ØªÙ† Ù…Ù‚ØµØ¯ (Ù…Ø­Ù„ Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø§Ø±Ø¬Ø§Ø¹):</div>
    <div id="targetText" class="text-box">
      <p>
        Ø§ÛŒÙ† Ù…ØªÙ† Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ Ù…Ù‚ØµØ¯ Ø§Ø±Ø¬Ø§Ø¹ Ø§Ø³Øª. Ø§Ø¨ØªØ¯Ø§ Ø¨Ø®Ø´ÛŒ Ø§Ø² Ø§ÛŒÙ† Ù…ØªÙ† Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ø±Ø¯Ù‡ Ùˆ
        Ø³Ù¾Ø³ Ø¯Ú©Ù…Ù‡ "Ø§Ø±Ø¬Ø§Ø¹" Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯. Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ù‚Ø³Ù…Øª Ú©Ù„Ù…Ù‡ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯ Ùˆ Ø¹Ø¯Ø¯ Ù…Ø±Ø¬Ø¹
        Ø¨Ù‡ Ø§Ù†ØªÙ‡Ø§ÛŒ Ú©Ù„Ù…Ù‡ Ø§Ø¶Ø§ÙÙ‡ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯.
      </p>
      <p>
        Ø§ÛŒÙ† Ù…ØªÙ† Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ Ù…Ù‚ØµØ¯ Ø§Ø±Ø¬Ø§Ø¹ Ø§Ø³Øª. Ø§Ø¨ØªØ¯Ø§ Ø¨Ø®Ø´ÛŒ Ø§Ø² Ø§ÛŒÙ† Ù…ØªÙ† Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ø±Ø¯Ù‡ Ùˆ
        Ø³Ù¾Ø³ Ø¯Ú©Ù…Ù‡ "Ø§Ø±Ø¬Ø§Ø¹" Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯. Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ù‚Ø³Ù…Øª Ú©Ù„Ù…Ù‡ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯ Ùˆ Ø¹Ø¯Ø¯ Ù…Ø±Ø¬Ø¹
        Ø¨Ù‡ Ø§Ù†ØªÙ‡Ø§ÛŒ Ú©Ù„Ù…Ù‡ Ø§Ø¶Ø§ÙÙ‡ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯.
      </p>
    </div>

    <button id="startReferenceBtn">Ø§Ø±Ø¬Ø§Ø¹</button>
    <button id="saveReferenceBtn" disabled>Ø«Ø¨Øª Ø§Ø±Ø¬Ø§Ø¹</button>

    <div class="debug-info" id="debugInfo">Ø¢Ù…Ø§Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ø§Ù†ØªØ®Ø§Ø¨</div>

    <script>
      let targetSelection = "";
      let targetRange = null;
      let referenceCounter = 1;

      const targetBox = document.getElementById("targetText");
      const sourceBox = document.getElementById("sourceText");
      const startBtn = document.getElementById("startReferenceBtn");
      const saveBtn = document.getElementById("saveReferenceBtn");
      const debugInfo = document.getElementById("debugInfo");

      const references = []; // Ø°Ø®ÛŒØ±Ù‡ Ø§Ø±Ø¬Ø§Ø¹â€ŒÙ‡Ø§

      function updateDebugInfo(message) {
        debugInfo.textContent = message;
      }

      function getSelectedTextInElement(el) {
        const selection = window.getSelection();
        if (!selection.rangeCount || selection.isCollapsed) return "";
        const range = selection.getRangeAt(0);
        const container = range.commonAncestorContainer;
        return el.contains(container) ? selection.toString() : "";
      }

      function findWordBoundaryAfterSelection(range) {
        // Ú©Ù„ÙˆÙ† range Ø¨Ø±Ø§ÛŒ Ø¹Ø¯Ù… ØªØºÛŒÛŒØ± Ø§ØµÙ„ÛŒ
        const workingRange = range.cloneRange();

        // Ø±ÙØªÙ† Ø¨Ù‡ Ø§Ù†ØªÙ‡Ø§ÛŒ Ø§Ù†ØªØ®Ø§Ø¨
        workingRange.collapse(false);

        // Ú¯Ø±ÙØªÙ† node Ø§Ù†ØªÙ‡Ø§ÛŒÛŒ Ùˆ Ù…ÙˆÙ‚Ø¹ÛŒØª
        let endNode = workingRange.endContainer;
        let endOffset = workingRange.endOffset;

        updateDebugInfo(`Node type: ${endNode.nodeType}, Offset: ${endOffset}`);

        // Ø§Ú¯Ø± Ø¯Ø± text node Ù‡Ø³ØªÛŒÙ…
        if (endNode.nodeType === Node.TEXT_NODE) {
          const text = endNode.textContent;

          // Ø¬Ø³ØªØ¬Ùˆ Ø¨Ø±Ø§ÛŒ Ø§ÙˆÙ„ÛŒÙ† ÙØ§ØµÙ„Ù‡ ÛŒØ§ Ù¾Ø§ÛŒØ§Ù† Ù…ØªÙ† Ø¨Ø¹Ø¯ Ø§Ø² Ù…ÙˆÙ‚Ø¹ÛŒØª ÙØ¹Ù„ÛŒ
          let insertPosition = endOffset;

          // Ø§Ú¯Ø± Ø¯Ø± ÙˆØ³Ø· Ú©Ù„Ù…Ù‡ Ù‡Ø³ØªÛŒÙ…ØŒ Ø¨Ø±Ùˆ Ø¨Ù‡ Ø§Ù†ØªÙ‡Ø§ÛŒ Ú©Ù„Ù…Ù‡
          while (
            insertPosition < text.length &&
            text[insertPosition] !== " " &&
            text[insertPosition] !== "\n" &&
            text[insertPosition] !== "\t"
          ) {
            insertPosition++;
          }

          updateDebugInfo(
            `Text: "${text.substring(
              endOffset,
              insertPosition
            )}", Position: ${insertPosition}`
          );

          // ØªÙ†Ø¸ÛŒÙ… Ù…ÙˆÙ‚Ø¹ÛŒØª Ø¬Ø¯ÛŒØ¯
          workingRange.setStart(endNode, insertPosition);
          workingRange.setEnd(endNode, insertPosition);

          return workingRange;
        }

        // Ø§Ú¯Ø± Ø¯Ø± element node Ù‡Ø³ØªÛŒÙ…ØŒ Ø³Ø¹ÛŒ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… text node Ù…Ù†Ø§Ø³Ø¨ Ù¾ÛŒØ¯Ø§ Ú©Ù†ÛŒÙ…
        if (endNode.nodeType === Node.ELEMENT_NODE) {
          const childNodes = endNode.childNodes;

          if (endOffset < childNodes.length) {
            const nextNode = childNodes[endOffset];
            if (nextNode.nodeType === Node.TEXT_NODE) {
              // Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ø§Ù†ØªÙ‡Ø§ÛŒ Ú©Ù„Ù…Ù‡ Ø¯Ø± Ø§ÛŒÙ† text node
              const text = nextNode.textContent;
              let insertPosition = 0;

              while (
                insertPosition < text.length &&
                text[insertPosition] !== " " &&
                text[insertPosition] !== "\n" &&
                text[insertPosition] !== "\t"
              ) {
                insertPosition++;
              }

              workingRange.setStart(nextNode, insertPosition);
              workingRange.setEnd(nextNode, insertPosition);

              return workingRange;
            }
          }
        }

        // fallback: Ù‡Ù…Ø§Ù† Ù…ÙˆÙ‚Ø¹ÛŒØª Ø§ØµÙ„ÛŒ
        return workingRange;
      }

      startBtn.addEventListener("click", () => {
        const selection = window.getSelection();
        const text = getSelectedTextInElement(targetBox);
        if (!text) {
          alert("Ù„Ø·ÙØ§Ù‹ Ø¹Ø¨Ø§Ø±ØªÛŒ Ø±Ø§ Ø¯Ø± Ù…ØªÙ† Ù…Ù‚ØµØ¯ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.");
          return;
        }
        targetSelection = text;
        targetRange = selection.getRangeAt(0).cloneRange();

        updateDebugInfo(`Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡: "${text}"`);

        alert(
          'Ø¹Ø¨Ø§Ø±Øª Ù…Ù‚ØµØ¯ Ø«Ø¨Øª Ø´Ø¯. Ø­Ø§Ù„Ø§ Ø§Ø² Ù…ØªÙ† Ù…Ø±Ø¬Ø¹ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯ Ùˆ Ø³Ù¾Ø³ Ø±ÙˆÛŒ "Ø«Ø¨Øª Ø§Ø±Ø¬Ø§Ø¹" Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯.'
        );
        saveBtn.disabled = false;
      });

      saveBtn.addEventListener("click", () => {
        const sourceSelection = getSelectedTextInElement(sourceBox);
        if (!sourceSelection) {
          alert("Ù„Ø·ÙØ§Ù‹ Ø¹Ø¨Ø§Ø±ØªÛŒ Ø±Ø§ Ø¯Ø± Ù…ØªÙ† Ù…Ø±Ø¬Ø¹ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.");
          return;
        }

        // Ù‡Ø§ÛŒÙ„Ø§ÛŒØª Ø¯Ø± Ù…Ù†Ø¨Ø¹
        const range = window.getSelection().getRangeAt(0);
        const highlightSpan = document.createElement("span");
        highlightSpan.className = "highlight";
        highlightSpan.textContent = sourceSelection;
        const refId = "ref-" + referenceCounter;
        highlightSpan.id = refId;
        range.deleteContents();
        range.insertNode(highlightSpan);
        window.getSelection().removeAllRanges();
        setTimeout(() => {
          const element = document.getElementById(refId);
          if (element) element.classList.remove("highlight");
        }, 1500);

        // Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ù…ÙˆÙ‚Ø¹ÛŒØª Ù…Ù†Ø§Ø³Ø¨ Ø¨Ø±Ø§ÛŒ Ø¯Ø±Ø¬ Ø¹Ø¯Ø¯ Ù…Ø±Ø¬Ø¹
        const insertRange = findWordBoundaryAfterSelection(targetRange);

        // Ø§ÛŒØ¬Ø§Ø¯ Ø¹Ù†ØµØ± Ù…Ø±Ø¬Ø¹
        const sup = document.createElement("span");
        sup.className = "ref-link";
        sup.textContent = "â½" + referenceCounter + "â¾";
        sup.title = "Ø±ÙØªÙ† Ø¨Ù‡ Ù…Ø±Ø¬Ø¹";
        sup.addEventListener("click", () => {
          const target = document.getElementById(refId);
          if (target) {
            target.scrollIntoView({ behavior: "auto", block: "center" });
            target.classList.add("highlight");
            setTimeout(() => target.classList.remove("highlight"), 1500);
          }
        });

        // Ø¯Ø±Ø¬ Ø¹Ø¯Ø¯ Ù…Ø±Ø¬Ø¹ Ø¯Ø± Ù…ÙˆÙ‚Ø¹ÛŒØª Ù…Ù†Ø§Ø³Ø¨
        try {
          insertRange.insertNode(sup);
          updateDebugInfo(`Ù…Ø±Ø¬Ø¹ ${referenceCounter} Ø¯Ø± Ù…ÙˆÙ‚Ø¹ÛŒØª Ù…Ù†Ø§Ø³Ø¨ Ø¯Ø±Ø¬ Ø´Ø¯`);
        } catch (error) {
          // fallback: Ø¯Ø±Ø¬ Ø¯Ø± Ø§Ù†ØªÙ‡Ø§ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ø§ØµÙ„ÛŒ
          targetRange.collapse(false);
          targetRange.insertNode(sup);
          updateDebugInfo(`Ù…Ø±Ø¬Ø¹ ${referenceCounter} Ø¨Ø§ fallback Ø¯Ø±Ø¬ Ø´Ø¯`);
        }

        // Ù¾Ø§Ú©â€ŒØ³Ø§Ø²ÛŒ
        referenceCounter++;
        targetSelection = "";
        targetRange = null;
        saveBtn.disabled = true;

        updateDebugInfo("Ø¢Ù…Ø§Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ø¬Ø¯ÛŒØ¯");
      });

      // Ù†Ù…Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª debug Ù‡Ù†Ú¯Ø§Ù… Ø§Ù†ØªØ®Ø§Ø¨
      document.addEventListener("selectionchange", () => {
        const selection = window.getSelection();
        if (!selection.isCollapsed) {
          const text = selection.toString();
          if (
            targetBox.contains(selection.anchorNode) ||
            targetBox.contains(selection.focusNode)
          ) {
            updateDebugInfo(`Ø§Ù†ØªØ®Ø§Ø¨ Ø¯Ø± Ù…ØªÙ† Ù…Ù‚ØµØ¯: "${text}"`);
          } else if (
            sourceBox.contains(selection.anchorNode) ||
            sourceBox.contains(selection.focusNode)
          ) {
            updateDebugInfo(`Ø§Ù†ØªØ®Ø§Ø¨ Ø¯Ø± Ù…ØªÙ† Ù…Ø±Ø¬Ø¹: "${text}"`);
          }
        }
      });
    </script>
  </body>
</html>
