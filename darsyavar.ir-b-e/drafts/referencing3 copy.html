<!DOCTYPE html>
<html lang="fa">
  <head>
    <meta charset="UTF-8" />
    <title>Ø¯Ø±Ø¬ Ø³ØªØ§Ø±Ù‡ Ø¨Ø¹Ø¯ Ø§Ø² Ù¾Ø§ÛŒØ§Ù† Ú©Ù„Ù…Ù‡</title>
    <style>
      body {
        font-family: sans-serif;
        line-height: 2;
        direction: rtl;
        padding: 2em;
      }

      #content {
        border: 1px solid #ccc;
        padding: 1em;
      }

      .star-marker {
        color: blue;
        font-weight: bold;
      }

      #saveBtn {
        margin-top: 1em;
        padding: 0.5em 1em;
      }

      .highlight {
        background-color: yellow;
      }
    </style>
  </head>
  <body>
    <div id="content">
      <p>Ù¾Ø§Ø±Ø§Ú¯Ø±Ø§Ù Ø§ÙˆÙ„: Ø²Ù†Ø¯Ú¯ÛŒ Ø²ÛŒØ¨Ø§Ø³Øª Ùˆ Ù¾Ø± Ø§Ø² ØªØ¬Ø±Ø¨Ù‡â€ŒÙ‡Ø§ÛŒ Ø¢Ù…ÙˆØ²Ù†Ø¯Ù‡.</p>
      <p>
        Ù¾Ø§Ø±Ø§Ú¯Ø±Ø§Ù Ø¯ÙˆÙ…: <span class="highlight">Ù…Ø·Ø§Ù„Ø¹Ù‡ Ù…Ø¯Ø§ÙˆÙ…</span> Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯
        Ù…ÙˆÙÙ‚ÛŒØª Ø±Ø§ ØªØ¶Ù…ÛŒÙ† Ú©Ù†Ø¯.
      </p>
      <p>
        Ù¾Ø§Ø±Ø§Ú¯Ø±Ø§Ù Ø³ÙˆÙ…: Ø¯Ø§Ù†Ø´ Ø²ÛŒØ³Øªâ€ŒØ´Ù†Ø§Ø³ÛŒ Ù…Ø§ Ø±Ø§ Ø¨Ø§ Ø³Ø§Ø®ØªØ§Ø±Ù‡Ø§ÛŒ Ù¾ÛŒÚ†ÛŒØ¯Ù‡ Ø­ÛŒØ§Øª Ø¢Ø´Ù†Ø§
        Ù…ÛŒâ€ŒØ³Ø§Ø²Ø¯.
      </p>
    </div>

    <button id="saveBtn">ğŸ“Œ Ø«Ø¨Øª Ù…Ø±Ø¬Ø¹</button>

    <script>
      function isWordChar(char) {
        return /[\wØ¢-ÛŒâ€Œ]/.test(char); // Ø´Ø§Ù…Ù„ Ø­Ø±ÙˆÙ ÙØ§Ø±Ø³ÛŒØŒ Ù„Ø§ØªÛŒÙ†ØŒ Ø¹Ø¯Ø¯ Ùˆ Ù†ÛŒÙ…â€ŒÙØ§ØµÙ„Ù‡
      }

      function expandToWordEnd(node, offset) {
        if (node.nodeType !== Node.TEXT_NODE) return offset;

        const text = node.nodeValue;
        let i = offset;

        while (i < text.length && isWordChar(text[i])) {
          i++;
        }

        return i; // Ø§Ù†Ø¯ÛŒØ³ Ø¨Ø¹Ø¯ Ø§Ø² Ø¢Ø®Ø±ÛŒÙ† Ú©Ø§Ø±Ø§Ú©ØªØ± Ú©Ù„Ù…Ù‡
      }

      document.getElementById("saveBtn").addEventListener("click", () => {
        const selection = window.getSelection();
        if (!selection.rangeCount || selection.isCollapsed) {
          alert("Ù„Ø·ÙØ§Ù‹ Ø¨Ø®Ø´ÛŒ Ø§Ø² Ù…ØªÙ† Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.");
          return;
        }

        const range = selection.getRangeAt(0);
        let endContainer = range.endContainer;
        let endOffset = range.endOffset;
        console.log(
          "Ù‚Ø¨Ù„ Ø§Ø² Ø¨Ø±Ø±Ø³ÛŒ:",
          endOffset,
          endContainer,
          endContainer.nodeValue
        );

        // Ø§Ú¯Ù‡ Ø¨Ù‡ Ù†ÙˆØ¯ ØºÛŒØ± Ù…ØªÙ†ÛŒ Ø®ØªÙ… Ø¨Ø´Ù‡ØŒ Ø¯Ù†Ø¨Ø§Ù„ Ø§ÙˆÙ„ÛŒÙ† Ù†ÙˆØ¯ Ù…ØªÙ†ÛŒ ØªÙˆÛŒ Ø§ÙˆÙ† Ù…ÛŒâ€ŒÚ¯Ø±Ø¯ÛŒÙ…
        if (
          endContainer.nodeType !== Node.TEXT_NODE &&
          endContainer.childNodes.length > 0
        ) {
          console.log("Ø§Ù†ØªØ®Ø§Ø¨ Ø¯Ø± Ù†ÙˆØ¯ ØºÛŒØ± Ù…ØªÙ†ÛŒ ØªÙ…Ø§Ù… Ø´Ø¯Ù‡ Ø§Ø³Øª");
          for (let child of endContainer.childNodes) {
            if (child.nodeType === Node.TEXT_NODE) {
              endContainer = child;
              endOffset = 0;
              console.log(
                "Ù†ÙˆØ¯ Ù…ØªÙ†ÛŒ Ù¾ÛŒØ¯Ø§ Ø´Ø¯:",
                endContainer,
                endContainer.nodeValue
              );
              break;
            }
          }
        }

        // Ø§Ú¯Ø± Ø¢Ø®Ø±ÛŒÙ† Ú©Ø§Ø±Ø§Ú©ØªØ± ÙˆØ³Ø· ÛŒÚ© Ú©Ù„Ù…Ù‡â€ŒØ³ØªØŒ Ø¨Ù‡ Ø§Ù†ØªÙ‡Ø§ÛŒ Ú©Ù„Ù…Ù‡ Ø¨Ø±Ùˆ
        const expandedOffset = expandToWordEnd(endContainer, endOffset);
        console.log("Ø¨Ø¹Ø¯ Ø§Ø² Ø¨Ø±Ø±Ø³ÛŒ:", expandedOffset, endContainer);

        // Ø³Ø§Ø®Øª Ùˆ Ø¯Ø±Ø¬ Ø³ØªØ§Ø±Ù‡
        const star = document.createElement("span");
        star.textContent = "*";
        star.className = "star-marker";

        const newRange = document.createRange();
        newRange.setStart(endContainer, expandedOffset);
        newRange.collapse(true); // insertion point

        newRange.insertNode(star);

        selection.removeAllRanges(); // Ù¾Ø§Ú©â€ŒÚ©Ø±Ø¯Ù† Ø§Ù†ØªØ®Ø§Ø¨
      });
    </script>
  </body>
</html>
