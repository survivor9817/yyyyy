<!DOCTYPE html>
<html lang="fa">
  <head>
    <meta charset="UTF-8" />
    <title>Ø§Ø±Ø¬Ø§Ø¹ Ø¨Ø§ Ø§Ø³Ú©Ø±ÙˆÙ„ Ùˆ Ù‡Ø§ÛŒÙ„Ø§ÛŒØª</title>
    <style>
      body {
        font-family: sans-serif;
        direction: rtl;
        padding: 20px;
      }
      .container {
        display: flex;
        gap: 20px;
      }
      .text-box {
        border: 1px solid #999;
        padding: 10px;
        width: 45%;
        height: 300px;
        overflow-y: auto;
        background: #fefefe;
        line-height: 2;
      }
      .label {
        font-weight: bold;
        margin-top: 20px;
      }
      .highlight {
        background-color: yellow;
        transition: background-color 0.5s;
      }
      .ref-link {
        color: blue;
        cursor: pointer;
        font-size: 0.8em;
        margin-right: 4px;
      }
    </style>
  </head>
  <body>
    <div class="label">ðŸŸ¨ Ù…ØªÙ† Ù…Ø±Ø¬Ø¹ (Ù…Ù†Ø¨Ø¹ Ø§Ø±Ø¬Ø§Ø¹):</div>
    <div id="sourceText" class="text-box" contenteditable="true">
      <p>
        Ø§ÛŒÙ† Ù…ØªÙ† Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ Ù…Ù†Ø¨Ø¹ Ø§Ø±Ø¬Ø§Ø¹ Ø§Ø³Øª. Ù…ÛŒâ€ŒØªÙˆØ§Ù† Ø¨Ø®Ø´â€ŒÙ‡Ø§ÛŒÛŒ Ø§Ø² Ø§ÛŒÙ† Ù…ØªÙ† Ø±Ø§ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù†
        Ù…Ø±Ø¬Ø¹ Ø¨Ø±Ø§ÛŒ Ø¨Ø®Ø´â€ŒÙ‡Ø§ÛŒ Ø¯ÛŒÚ¯Ø± Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ø±Ø¯. Ù‡Ø± Ø¬Ù…Ù„Ù‡ Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø¨Ù‡ ÛŒÚ© Ø¹Ø¨Ø§Ø±Øª Ø®Ø§Øµ
        Ø§Ø±Ø¬Ø§Ø¹ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯.
      </p>
      <p>
        Ø§ÛŒÙ† Ù…ØªÙ† Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ Ù…Ù†Ø¨Ø¹ Ø§Ø±Ø¬Ø§Ø¹ Ø§Ø³Øª. Ù…ÛŒâ€ŒØªÙˆØ§Ù† Ø¨Ø®Ø´â€ŒÙ‡Ø§ÛŒÛŒ Ø§Ø² Ø§ÛŒÙ† Ù…ØªÙ† Ø±Ø§ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù†
        Ù…Ø±Ø¬Ø¹ Ø¨Ø±Ø§ÛŒ Ø¨Ø®Ø´â€ŒÙ‡Ø§ÛŒ Ø¯ÛŒÚ¯Ø± Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ø±Ø¯. Ù‡Ø± Ø¬Ù…Ù„Ù‡ Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø¨Ù‡ ÛŒÚ© Ø¹Ø¨Ø§Ø±Øª Ø®Ø§Øµ
        Ø§Ø±Ø¬Ø§Ø¹ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯.
      </p>
      <p>
        Ø§ÛŒÙ† Ù…ØªÙ† Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ Ù…Ù†Ø¨Ø¹ Ø§Ø±Ø¬Ø§Ø¹ Ø§Ø³Øª. Ù…ÛŒâ€ŒØªÙˆØ§Ù† Ø¨Ø®Ø´â€ŒÙ‡Ø§ÛŒÛŒ Ø§Ø² Ø§ÛŒÙ† Ù…ØªÙ† Ø±Ø§ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù†
        Ù…Ø±Ø¬Ø¹ Ø¨Ø±Ø§ÛŒ Ø¨Ø®Ø´â€ŒÙ‡Ø§ÛŒ Ø¯ÛŒÚ¯Ø± Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ø±Ø¯. Ù‡Ø± Ø¬Ù…Ù„Ù‡ Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø¨Ù‡ ÛŒÚ© Ø¹Ø¨Ø§Ø±Øª Ø®Ø§Øµ
        Ø§Ø±Ø¬Ø§Ø¹ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯.
      </p>
    </div>

    <div class="label">ðŸŸ¦ Ù…ØªÙ† Ù…Ù‚ØµØ¯ (Ù…Ø­Ù„ Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø§Ø±Ø¬Ø§Ø¹):</div>
    <div id="targetText" class="text-box" contenteditable="true">
      Ø§ÛŒÙ† Ù…ØªÙ† Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ Ù…Ù‚ØµØ¯ Ø§Ø±Ø¬Ø§Ø¹ Ø§Ø³Øª. Ø§Ø¨ØªØ¯Ø§ Ø¨Ø®Ø´ÛŒ Ø§Ø² Ø§ÛŒÙ† Ù…ØªÙ† Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ø±Ø¯Ù‡ Ùˆ
      Ø³Ù¾Ø³ Ø¯Ú©Ù…Ù‡ "Ø§Ø±Ø¬Ø§Ø¹" Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯.
    </div>

    <button id="startReferenceBtn">Ø§Ø±Ø¬Ø§Ø¹</button>
    <button id="saveReferenceBtn" disabled>Ø«Ø¨Øª Ø§Ø±Ø¬Ø§Ø¹</button>

    <script>
      let targetSelection = "";
      let targetRange = null;
      let referenceCounter = 1;

      const targetBox = document.getElementById("targetText");
      const sourceBox = document.getElementById("sourceText");
      const startBtn = document.getElementById("startReferenceBtn");
      const saveBtn = document.getElementById("saveReferenceBtn");

      const references = []; // Ø°Ø®ÛŒØ±Ù‡ Ø§Ø±Ø¬Ø§Ø¹â€ŒÙ‡Ø§

      function getSelectedTextInElement(el) {
        const selection = window.getSelection();
        if (!selection.rangeCount || selection.isCollapsed) return "";
        const range = selection.getRangeAt(0);
        const container = range.commonAncestorContainer;
        return el.contains(container) ? selection.toString() : "";
      }

      startBtn.addEventListener("click", () => {
        const selection = window.getSelection();
        const text = getSelectedTextInElement(targetBox);
        if (!text) {
          alert("Ù„Ø·ÙØ§Ù‹ Ø¹Ø¨Ø§Ø±ØªÛŒ Ø±Ø§ Ø¯Ø± Ù…ØªÙ† Ù…Ù‚ØµØ¯ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.");
          return;
        }
        targetSelection = text;
        targetRange = selection.getRangeAt(0).cloneRange(); // Ù†Ú¯Ù‡Ø¯Ø§Ø±ÛŒ Ù…Ø­Ø¯ÙˆØ¯Ù‡
        alert(
          'Ø¹Ø¨Ø§Ø±Øª Ù…Ù‚ØµØ¯ Ø«Ø¨Øª Ø´Ø¯. Ø­Ø§Ù„Ø§ Ø§Ø² Ù…ØªÙ† Ù…Ø±Ø¬Ø¹ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯ Ùˆ Ø³Ù¾Ø³ Ø±ÙˆÛŒ "Ø«Ø¨Øª Ø§Ø±Ø¬Ø§Ø¹" Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯.'
        );
        saveBtn.disabled = false;
      });

      saveBtn.addEventListener("click", () => {
        const sourceSelection = getSelectedTextInElement(sourceBox);
        if (!sourceSelection) {
          alert("Ù„Ø·ÙØ§Ù‹ Ø¹Ø¨Ø§Ø±ØªÛŒ Ø±Ø§ Ø¯Ø± Ù…ØªÙ† Ù…Ø±Ø¬Ø¹ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.");
          return;
        }

        // Ù‡Ø§ÛŒÙ„Ø§ÛŒØª Ø¯Ø± Ù…Ù†Ø¨Ø¹
        const range = window.getSelection().getRangeAt(0);
        const highlightSpan = document.createElement("span");
        highlightSpan.className = "highlight";
        highlightSpan.textContent = sourceSelection;
        const refId = "ref-" + referenceCounter;
        highlightSpan.id = refId;
        range.deleteContents();
        range.insertNode(highlightSpan);
        window.getSelection().removeAllRanges();
        setTimeout(
          () => document.getElementById(refId).classList.remove("highlight"),
          1500
        );

        // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø´Ù…Ø§Ø±Ù‡ Ø¨Ù‡ Ù…Ù‚ØµØ¯
        const sup = document.createElement("span");
        sup.className = "ref-link";
        sup.textContent = "â½" + referenceCounter + "â¾";
        sup.title = "Ø±ÙØªÙ† Ø¨Ù‡ Ù…Ø±Ø¬Ø¹";
        sup.addEventListener("click", () => {
          const target = document.getElementById(refId);
          if (target) {
            target.scrollIntoView({ behavior: "auto", block: "center" });
            target.classList.add("highlight");
            setTimeout(() => target.classList.remove("highlight"), 1500);
          }
        });

        // Ù‚Ø±Ø§Ø± Ø¯Ø§Ø¯Ù† Ø¨Ø¹Ø¯ Ø§Ø² Ø¢Ø®Ø±ÛŒÙ† Ú©Ø§Ø±Ø§Ú©ØªØ± Ø§Ù†ØªØ®Ø§Ø¨â€ŒØ´Ø¯Ù‡
        targetRange.collapse(false); // move to end
        targetRange.insertNode(sup);

        // Ù¾Ø§Ú©â€ŒØ³Ø§Ø²ÛŒ
        referenceCounter++;
        targetSelection = "";
        targetRange = null;
        saveBtn.disabled = true;
      });
    </script>
  </body>
</html>
